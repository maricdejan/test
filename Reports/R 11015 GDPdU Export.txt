OBJECT Report 11015 GDPdU Export
{
  OBJECT-PROPERTIES
  {
    Date=14.08.09;
    Time=12:00:00;
    Version List=NAVDACH6.00.01;
  }
  PROPERTIES
  {
    CaptionML=[DEU=GDPdU Export;
               ENU=GDPdU Export];
    ProcessingOnly=Yes;
    OnPreReport=BEGIN
                  IF ISCLEAR(FileSysObjectServer) THEN
                    CREATE(FileSysObjectServer,TRUE);
                  IF ISCLEAR(FileSysObjectClient) THEN
                    CREATE(FileSysObjectClient,TRUE,TRUE);
                END;

    OnPostReport=BEGIN
                   CLEAR(FileSysObjectServer);
                   CLEAR(FileSysObjectClient);
                 END;

  }
  DATAITEMS
  {
    { PROPERTIES
      {
        DataItemTable=Table11003;
        DataItemTableView=SORTING(Definition Group Code,Record Code);
        OnPreDataItem=BEGIN
                        IF Startdate = 0D THEN
                          ERROR(Text1140008);

                        IF Enddate = 0D THEN
                          ERROR(Text1140009);

                        IF MediaSize = 0 THEN
                          ERROR(Text1140003);


                        IF DTDPathFileName = '' THEN
                          ERROR(Text1140012);

                        IF NOT FileSysObjectClient.FileExists(DTDPathFileName) THEN
                            ERROR(Text1140012);

                        DTDFileName := FileSysObjectClient.GetFileName(DTDPathFileName);

                        CurrMedia := MediaSize;
                        TotalMediaSize := CurrMedia * 1000;

                        Window.OPEN(Text1140042 + Text1140089);
                        NotCreated := TRUE;
                        FirstMediaSize := TRUE;
                        FolderExist := TRUE;
                        CheckPath := TRUE;

                        TempRecRef.OPEN(11010,TRUE);
                      END;

        OnAfterGetRecord=VAR
                           GDPdUMgt@1140000 : Codeunit 11000;
                         BEGIN


                           WITH TempGDPdURecDefTable DO BEGIN
                             SETCURRENTKEY("Definition Group Code","Record Code","Line No.");
                             SETRANGE("Definition Group Code","GDPdU Record Definition"."Definition Group Code");
                             SETRANGE("Record Code","GDPdU Record Definition"."Record Code");
                             IF TempGDPdURecDefTable.FINDSET THEN
                               REPEAT
                                 TotalRecords := 0;
                                 RecordRefTable.OPEN("Table No.");
                                 Window.UPDATE(1,RecordRefTable.CAPTION);
                                 SetPeriodFilter("GDPdU Period Field No.",RecordRefTable,FldRefTable);
                                 RecordRefTable.CURRENTKEYINDEX(FindKeyIndex("Table No."));
                                 IF RecordRefTable.FINDFIRST THEN BEGIN
                                   TotalRecords :=  RecordRefTable.COUNTAPPROX;
                                   TempFilesGDPdUExportBuffer.RESET;
                                   TempFilesGDPdUExportBuffer.SETCURRENTKEY("Table No.","Line No.");
                                   TempFilesGDPdUExportBuffer.SETRANGE("Table No.", "Table No.");
                                   IF NOT TempFilesGDPdUExportBuffer.FINDLAST THEN BEGIN
                                     NextNo := NextNo + 1;
                                     TempFilesGDPdUExportBuffer.INIT;
                                     TempFilesGDPdUExportBuffer."Entry No." := NextNo;
                                     TempFilesGDPdUExportBuffer."Table No." := "Table No.";
                                     TempFilesGDPdUExportBuffer."Field Value" := RecordRefTable.CAPTION;
                                     TempFilesGDPdUExportBuffer."Line No." := TotalRecords;
                                     TempFilesGDPdUExportBuffer."File No." := 0;
                                     TempFilesGDPdUExportBuffer.INSERT;
                                   END;
                                 END ELSE BEGIN
                                   TempFilesGDPdUExportBuffer.RESET;
                                   TempFilesGDPdUExportBuffer.SETCURRENTKEY("Table No.","Line No.");
                                   TempFilesGDPdUExportBuffer.SETRANGE("Table No.","Table No.");
                                   IF NOT TempFilesGDPdUExportBuffer.FINDLAST THEN BEGIN
                                     NextNo := NextNo + 1;
                                     TempFilesGDPdUExportBuffer.INIT;
                                     TempFilesGDPdUExportBuffer."Entry No." := NextNo;
                                     TempFilesGDPdUExportBuffer."Table No." := "Table No.";
                                     TempFilesGDPdUExportBuffer."Field Value" := RecordRefTable.CAPTION;
                                     TempFilesGDPdUExportBuffer."Line No." := 0;
                                     TempFilesGDPdUExportBuffer."File No." := 0;
                                     TempFilesGDPdUExportBuffer.INSERT;
                                   END;
                                 END;
                                 TotalNoOfRecords := TotalNoOfRecords + TotalRecords;
                                 Window.UPDATE(1,'');
                                 RecordRefTable.CLOSE;
                               UNTIL TempGDPdURecDefTable.NEXT = 0;
                           END;

                           TESTFIELD(Description);
                           TESTFIELD("Export Path");

                           NotCreated := TRUE;
                           NoOfDefinedTables := 0;
                           NoOfEmptyTables := 0;

                           IF "Export Path"[STRLEN("Export Path")] = '\' THEN
                             "Export Path" := DELSTR("Export Path",STRLEN("Export Path"),1);

                           IF NOT FileSysObjectClient.FolderExists("Export Path") THEN
                             ERROR(Text1140004);

                           ExportPath := "Export Path" + '\' + "Record Code";
                           CreateExportFolder(ExportPath + ' 1');

                           CheckingRecordDefFields("Definition Group Code","Record Code");

                           CLEAR(NextEntryNo);
                           CLEAR(OldTableNo);

                           FileIsOpen := FALSE;
                           ExportGDPdURecDefTable("Definition Group Code","Record Code");

                           Window.UPDATE(1,Text1140005);
                           GDPdUMgt.CreateIndexXML(
                             TempGDPdUXMLBuffer,FileSysObjectClient,ExportPath + ' 1',Description,
                               "Definition Group Code","Record Code",Startdate,Enddate,DTDFileName);

                           Window.UPDATE(1,Text1140046);
                           IF NOT ISSERVICETIER THEN
                             TextStream := FileSysObjectServer.CreateTextFile(ExportPath + ' 1\' + 'Log.txt')
                           ELSE
                             TextStream := FileSysObjectServer.CreateTextFile(Path + '\' +'Log.txt');
                           TextStream.WriteLine(FORMAT(Startdate) +' To '+ FORMAT(Enddate));
                           TextStream.WriteLine(FORMAT(TODAY));
                           TextStream.WriteLine("GDPdU Record Definition"."Definition Group Code" +';'+ "GDPdU Record Definition"."Record Code");
                           TempFilesGDPdUExportBuffer.RESET;
                           TempFilesGDPdUExportBuffer.SETRANGE("Entry No.");
                           IF TempFilesGDPdUExportBuffer.FINDSET THEN
                             REPEAT
                               TextStream.WriteLine(Text1140047 + TempFilesGDPdUExportBuffer."Field Value" +Text1140052 +
                                 FORMAT(TempFilesGDPdUExportBuffer."Line No.") + Text1140090
                                 + FORMAT(TempFilesGDPdUExportBuffer."File No.") + Text1140086);
                               IF TempFilesGDPdUExportBuffer."Line No." <> 0 THEN
                                 NoOfDefinedTables := NoOfDefinedTables + 1
                               ELSE
                                 NoOfEmptyTables := NoOfEmptyTables + 1;
                             UNTIL TempFilesGDPdUExportBuffer.NEXT = 0;
                           TextStream.WriteLine(Text1140050 + FORMAT(NoOfDefinedTables));
                           TextStream.WriteLine(Text1140051 + FORMAT(NoOfEmptyTables));
                           TextStream.Close;
                           IF ISSERVICETIER THEN BEGIN
                             TempPath := RBMgt.DownloadTempFile(Path + '\' + 'Log.txt');
                             FileSysObjectServer.DeleteFile(Path + '\' + 'Log.txt',TRUE);
                             FileSysObjectClient.MoveFile(TempPath,ExportPath + ' ' + FORMAT(1) + '\' + 'Log.txt');
                           END;

                           DeleteTempTables;
                         END;

        OnPostDataItem=BEGIN
                         TempRecRef.CLOSE;
                       END;

        ReqFilterFields=Definition Group Code,Record Code;
      }
      SECTIONS
      {
      }
       }
  }
  REQUESTFORM
  {
    PROPERTIES
    {
      Width=8910;
      Height=2750;
      SaveValues=Yes;
    }
    CONTROLS
    {
      { 1140000;TextBox   ;3410 ;0    ;1700 ;440  ;CaptionML=[DEU=Startdatum;
                                                              ENU=Starting Date];
                                                   SourceExpr=Startdate }
      { 1140001;Label     ;0    ;0    ;3300 ;440  ;ParentControl=1140000 }
      { 1140002;TextBox   ;3410 ;550  ;1700 ;440  ;CaptionML=[DEU=Enddatum;
                                                              ENU=Ending Date];
                                                   SourceExpr=Enddate }
      { 1140003;Label     ;0    ;550  ;3300 ;440  ;ParentControl=1140002 }
      { 1140004;TextBox   ;3410 ;1650 ;1700 ;440  ;CaptionML=[DEU=DatentrÑgergrî·e (KB);
                                                              ENU=Media Size (KB)];
                                                   SourceExpr=MediaSize }
      { 1140005;Label     ;0    ;1650 ;3300 ;440  ;ParentControl=1140004 }
      { 1140006;TextBox   ;3410 ;2200 ;5500 ;440  ;Name=DTDFileName;
                                                   CaptionML=[DEU=DTD Dateiname;
                                                              ENU=DTD File Name];
                                                   SourceExpr=DTDPathFileName;
                                                   OnAssistEdit=VAR
                                                                  CommonDialogMgt@1140000 : Codeunit 412;
                                                                BEGIN
                                                                  DTDPathFileName := CommonDialogMgt.OpenFile(Text1140006,DTDPathFileName,4,Text1140007,0);
                                                                END;
                                                                 }
      { 1140007;Label     ;0    ;2200 ;3300 ;440  ;ParentControl=1140006 }
      { 1140084;CheckBox  ;3410 ;1100 ;440  ;440  ;ShowCaption=No;
                                                   CaptionML=[DEU=Ultimodatum einschlie·en;
                                                              ENU=Include Closing Date];
                                                   SourceExpr=CloseDate }
      { 1140085;Label     ;0    ;1100 ;3300 ;440  ;ParentControl=1140084 }
    }
  }
  REQUESTPAGE
  {
    PROPERTIES
    {
      SaveValues=Yes;
    }
    CONTROLS
    {
      { 1900000001;0;Container;
                  ContainerType=ContentArea }

      { 1900000002;1;Group  ;
                  CaptionML=[DEU=Optionen;
                             ENU=Options] }

      { 1140000;2;Field     ;
                  CaptionML=[DEU=Startdatum;
                             ENU=Starting Date];
                  SourceExpr=Startdate }

      { 1140002;2;Field     ;
                  CaptionML=[DEU=Enddatum;
                             ENU=Ending Date];
                  SourceExpr=Enddate }

      { 1140084;2;Field     ;
                  CaptionML=[DEU=Ultimodatum einschlie·en;
                             ENU=Include Closing Date];
                  SourceExpr=CloseDate }

      { 1140004;2;Field     ;
                  CaptionML=[DEU=DatentrÑgergrî·e (KB);
                             ENU=Media Size (KB)];
                  SourceExpr=MediaSize }

      { 1140006;2;Field     ;
                  Name=DTDFileName;
                  CaptionML=[DEU=DTD Dateiname;
                             ENU=DTD File Name];
                  SourceExpr=DTDPathFileName;
                  OnAssistEdit=VAR
                                 CommonDialogMgt@1140000 : Codeunit 412;
                               BEGIN
                                 DTDPathFileName := CommonDialogMgt.OpenFile(Text1140006,DTDPathFileName,4,Text1140007,0);
                               END;
                                }

    }
  }
  CODE
  {
    VAR
      TempGDPdUExportBuffer@1140013 : TEMPORARY Record 11008;
      TempGDPdUXMLBuffer@1140014 : TEMPORARY Record 11009;
      KeyFieldBuffer@1140015 : TEMPORARY Record 11010;
      TempFilesGDPdUExportBuffer@1140062 : TEMPORARY Record 11008;
      TempGDPdURecDefTable@1140094 : Record 11004;
      TempSizeGDPdUExportBuffer@1140058 : TEMPORARY Record 11008;
      TempRecRef@1140016 : RecordRef;
      RecordRefTable@1140067 : RecordRef;
      RBMgt@1140049 : Codeunit 419;
      FileSysObjectServer@1140017 : Automation "{F935DC20-1CF0-11D0-ADB9-00C04FD58A0B} 1.0:{0D43FE01-F093-11CF-8940-00A0C9054228}:'Windows Script Host Object Model'.FileSystemObject";
      FileSysObjectClient@1140043 : Automation "{F935DC20-1CF0-11D0-ADB9-00C04FD58A0B} 1.0:{0D43FE01-F093-11CF-8940-00A0C9054228}:'Windows Script Host Object Model'.FileSystemObject";
      TextStream@1140080 : Automation "{F935DC20-1CF0-11D0-ADB9-00C04FD58A0B} 1.0:{0BB02EC0-EF49-11CF-8940-00A0C9054228}:'Windows Script Host Object Model'.TextStream";
      FileSysObjectFoldercheck@1140081 : Automation "{F935DC20-1CF0-11D0-ADB9-00C04FD58A0B} 1.0:{C7C3F5B3-88A3-11D0-ABCB-00A0C90FFFC0}:'Windows Script Host Object Model'.Folder";
      FileSysObjectFileSizecheck@1140099 : Automation "{F935DC20-1CF0-11D0-ADB9-00C04FD58A0B} 1.0:{C7C3F5B5-88A3-11D0-ABCB-00A0C90FFFC0}:'Windows Script Host Object Model'.File";
      Startdate@1140020 : Date;
      Enddate@1140021 : Date;
      CloseDate1@1140073 : Date;
      Window@1140022 : Dialog;
      FldRefTable@1140097 : FieldRef;
      NextEntryNo@1140023 : Integer;
      MediaSize@1140024 : Integer;
      CurrentMediaSize@1140025 : BigInteger;
      TotalMediaSize@1140091 : BigInteger;
      CurrMedia@1140092 : BigInteger;
      DTDFileLength@1140026 : Integer;
      ExportBufferNextLineNo@1140033 : Integer;
      OldTableNo@1140034 : Integer;
      NoOfDefinedTables@1140068 : Integer;
      NoOfEmptyTables@1140069 : Integer;
      TotalNoOfRecords@1140070 : Integer;
      NumberOfFolders@1140074 : Integer;
      NextNo@1140077 : Integer;
      TotNoOfRecords@1140078 : Integer;
      NoOfRecords@1140066 : Integer;
      TotalRecords@1140095 : Integer;
      TotalFileSize@1140019 : Integer;
      FileSizeTotal@1140031 : Integer;
      NextEntryNoTemp@1140056 : Integer;
      StepValue@1101100002 : Integer;
      NextStep@1101100001 : Integer;
      ExportPath@1140027 : Text[120];
      DTDPathFileName@1140028 : Text[250];
      DTDFileName@1140029 : Text[250];
      GDPdUExportBufferFilename@1140036 : Text[250];
      FromFile@1140044 : Text[1024];
      ToFile@1140045 : Text[1024];
      ClientFile@1140002 : Text[1024];
      Date@1140072 : Text[30];
      BufferTextRec@1140075 : Text[1024];
      FolderSizeinText@1140083 : Text[30];
      LogFileName@1140065 : Text[250];
      FileSizeinText@1140035 : Text[30];
      TempPath@1140054 : Text[1024];
      FileName@1140084 : Text[50];
      Path@1140085 : Text[1024];
      TempFileName@1140059 : Text[250];
      FileIsOpen@1140030 : Boolean;
      NewFileStarted@1140048 : Boolean;
      CloseDate@1140071 : Boolean;
      FirstMediaSize@1140076 : Boolean;
      NotCreated@1140063 : Boolean;
      FolderExist@1140093 : Boolean;
      CheckPath@1140060 : Boolean;
      TextStreamIsOpen@1140018 : Boolean;
      FolderSize@1140082 : Variant;
      Text1140000@1140000 : TextConst 'DEU=Exportiere Daten von Tabelle: #1##################;ENU=Exporting data from table: #1##################';
      Text1140001@1140001 : TextConst 'DEU="""";ENU=""""';
      Text1140003@1140003 : TextConst 'DEU=Sie mÅssen die DatentrÑgergrîsse angeben.;ENU=You must enter a media size.';
      Text1140004@1140004 : TextConst 'DEU=Der Exportpfad existiert nicht.;ENU=The export path does not exist.';
      Text1140005@1140005 : TextConst 'DEU=Erstelle XML Datei...;ENU=Creating XML File...';
      Text1140006@1140006 : TextConst 'DEU=DTD Datei auswÑhlen;ENU=Choose DTD File';
      Text1140007@1140007 : TextConst 'DEU=DTD Dateien|*.dtd|Alle Dateien|*.*;ENU=DTD Files|*.dtd|All Files|*.*';
      Text1140008@1140008 : TextConst 'DEU=Sie mÅssen ein Startdatum angeben.;ENU=You must enter a starting date.';
      Text1140009@1140009 : TextConst 'DEU=Sie mÅssen ein Enddatum angeben.;ENU=You must enter an ending date.';
      Text1140010@1140010 : TextConst 'DEU=FÅr die Tabelle ''%2'' muss eine %1 definiert werden.;ENU=You must define a %1 for table %2.';
      Text1140011@1140011 : TextConst 'DEU=Sie mÅssen einen DTD Dateiname angeben.;ENU=You must enter a DTD File Name.';
      Text1140012@1140012 : TextConst 'DEU=Die DTD Datei existiert nicht.;ENU=The DTD file does not exist.';
      Text1140037@1140037 : TextConst 'DEU=Wichtiger Hinweis:;ENU=Important Notice:';
      Text1140038@1140038 : TextConst 'DEU=Der %1 fÅr die von Ihnen definierte Tabelle %2 enthÑlt PrimÑrschlÅsselfelder, die nicht oben in der Liste angegeben sind.;ENU=The %1 for table %2 you defined contains primary key fields which are not specified at the top of the list.';
      Text1140039@1140039 : TextConst 'DEU=Beachten Sie, dass in diesem Fall die Reihenfolge der zu exportierenden Felder nicht mit der in der XML-Datei angegebenen Reihenfolge Åbereinstimmt.;ENU=Please keep in mind that in this case the order of the fields to be exported won''t match the order stated in the XML file.';
      Text1140040@1140040 : TextConst 'DEU=Wenn Sie die exportierten Daten fÅr GDPdU-Zwecke verwenden mîchten, stellen Sie sicher, dass die PrimÑrschlÅsselfelder zuerst und die gewîhnlichen Felder daran anschlie·end angegeben werden.;ENU=If you want to use the exported data for GDPdU purposes please make sure that primary key fields are specified first and then ordinary fields.';
      Text1140041@1140041 : TextConst 'DEU=Soll der Vorgang fortgesetzt werden?;ENU=Do you want to continue?';
      Text1140042@1140042 : TextConst 'DEU=Tabellenname:                   #1#################\;ENU=Table Name:       #1#################\';
      Text1140046@1140046 : TextConst 'DEU=Protokolldatei wird erstellt...;ENU=Creating Log File...';
      Text1140047@1140047 : TextConst 'DEU="Tabelle ";ENU="Table "';
      Text1140050@1140050 : TextConst 'DEU="Anzahl der definierten Tabellen:  ";ENU="Number of defined tables:  "';
      Text1140051@1140051 : TextConst 'DEU="Anzahl der leeren Tabellen:  ";ENU="Number of empty tables:  "';
      Text1140052@1140052 : TextConst 'DEU=,;ENU=,';
      Text1140053@1140053 : TextConst 'DEU="Eine Datei bzw. ein Ordner mit dem gleichen Namen ist bereits vorhanden. öberschreiben? ";ENU="A file / folder with the same name already exist. Would you like to overwrite it? "';
      Text1140086@1140086 : TextConst 'DEU=" erstellte Datei(en)";ENU=" file(s) created"';
      Text1140087@1140087 : TextConst 'DEU=Gesamtanzahl der DatensÑtze:    #2#################\;ENU=Total records:    #2#################\';
      Text1140088@1140088 : TextConst 'DEU=Exportierte DatensÑtze:         #3#################\;ENU=Records exporting:#3#################\';
      Text1140089@1140089 : TextConst 'DEU=Status:                         @5@@@@@@@@@@@@@@@@@\;ENU=Progress:         @5@@@@@@@@@@@@@@@@@\';
      Text1140090@1140090 : TextConst 'DEU=" DatensÑtze exportiert,";ENU=" data records exported,"';
      FileSize@1140055 : Variant;

    LOCAL PROCEDURE ExportGDPdURecDefTable@1140000(GDPdUDefGrpCode@1140000 : Code[10];GDPdURecordCode@1140001 : Code[10]);
    VAR
      GDPdURecDefTable@1140002 : Record 11004;
      RecRef@1140003 : RecordRef;
      FldRef@1140004 : FieldRef;
    BEGIN
      NumberOfFolders := 1;

      WITH GDPdURecDefTable DO BEGIN
        SETCURRENTKEY("Definition Group Code","Record Code","Relation To Table No.");
        SETRANGE("Definition Group Code",GDPdUDefGrpCode);
        SETRANGE("Record Code",GDPdURecordCode);
        SETRANGE("Relation To Table No.",0);
        IF GDPdURecDefTable.FIND('-') THEN
          REPEAT
            RecRef.OPEN("Table No.");
            FindRecordRef(GDPdURecDefTable,RecRef,FldRef);
            RecRef.CLOSE;
          UNTIL NEXT = 0;
        END;

      IF ISSERVICETIER THEN BEGIN
        TextStreamClose;
        TempSizeGDPdUExportBuffer.RESET;
        TempSizeGDPdUExportBuffer.SETCURRENTKEY("Entry No.");
        IF TempSizeGDPdUExportBuffer.FINDSET THEN
          REPEAT
            IF FileSysObjectServer.FileExists(FileSysObjectServer.GetAbsolutePathName(TempSizeGDPdUExportBuffer."Field Value")) THEN
              BEGIN
                FileName := FileSysObjectServer.GetFileName(TempSizeGDPdUExportBuffer."Field Value");
                TempPath := RBMgt.DownloadTempFile(TempSizeGDPdUExportBuffer."Field Value");
                FileSysObjectServer.DeleteFile(TempSizeGDPdUExportBuffer."Field Value",TRUE);
                FileSysObjectClient.MoveFile(TempPath,ExportPath + ' ' + FORMAT(NumberOfFolders) + '\' + FileName);
            END;
          UNTIL TempSizeGDPdUExportBuffer.NEXT = 0;
      END;
      TempSizeGDPdUExportBuffer.RESET;
      TempSizeGDPdUExportBuffer.DELETEALL;
    END;

    LOCAL PROCEDURE FindRecordRef@1140001(GDPdURecDefTable@1140000 : Record 11004;VAR RecRef@1140001 : RecordRef;VAR FldRef@1140002 : FieldRef);
    BEGIN
      WITH GDPdURecDefTable DO BEGIN
        TESTFIELD("Export File Name");
        SetPeriodFilter("GDPdU Period Field No.",RecRef,FldRef);
        RecRef.CURRENTKEYINDEX(FindKeyIndex("Table No."));
        IF RecRef.FIND('-') THEN BEGIN
          Window.UPDATE(1,RecRef.CAPTION);
          REPEAT
            IF InsertTempKeyBuffer(RecRef) THEN BEGIN
              FindGDPdURecDefField(GDPdURecDefTable,RecRef);
              FindRelatedRecords("Definition Group Code","Record Code","Table No.",RecRef);
            END;
          UNTIL RecRef.NEXT = 0;
        END;
      END;
    END;

    LOCAL PROCEDURE FindRelatedRecords@1140002(GDPdUDefGrpCode@1140000 : Code[10];GDPdURecordCode@1140001 : Code[10];RelToTableID@1140002 : Integer;RecRef@1140003 : RecordRef);
    VAR
      GDPdURecDefTable@1140004 : Record 11004;
      GDPdUTableRelation@1140005 : Record 11006;
      RelatedRecRef@1140006 : RecordRef;
      RelatedFldRef@1140007 : FieldRef;
      FldRef@1140008 : FieldRef;
    BEGIN
      WITH GDPdURecDefTable DO BEGIN
        SETCURRENTKEY("Definition Group Code","Record Code","Line No.");
        SETRANGE("Definition Group Code",GDPdUDefGrpCode);
        SETRANGE("Record Code",GDPdURecordCode);
        SETRANGE("Relation To Table No.",RelToTableID);
        IF FIND('-') THEN
          REPEAT
            TESTFIELD("Export File Name");
            GDPdUTableRelation.SETRANGE("Definition Group Code",GDPdUDefGrpCode);
            GDPdUTableRelation.SETRANGE("Record Code",GDPdURecordCode);
            GDPdUTableRelation.SETRANGE("From Table No.",RelToTableID);
            GDPdUTableRelation.SETRANGE("To Table No.","Table No.");
            IF GDPdUTableRelation.FIND('-') THEN BEGIN
              RelatedRecRef.OPEN("Table No.");
              REPEAT
                FldRef := RecRef.FIELD(GDPdUTableRelation."From Field No.");
                RelatedFldRef := RelatedRecRef.FIELD(GDPdUTableRelation."To Field No.");
                RelatedFldRef.SETRANGE(FldRef.VALUE);
                FindKeyFields("Table No.",RelatedFldRef.NAME);
              UNTIL GDPdUTableRelation.NEXT = 0;
            END ELSE BEGIN
              CALCFIELDS("Table Name");
              ERROR(Text1140010,GDPdUTableRelation.TABLECAPTION,GDPdURecDefTable."Table Name");
            END;
            FindRecordRef(GDPdURecDefTable,RelatedRecRef,RelatedFldRef);
            RelatedRecRef.CLOSE;
          UNTIL NEXT = 0;
      END;
    END;

    LOCAL PROCEDURE SetPeriodFilter@1140003(PeriodFieldNo@1140000 : Integer;VAR RecRef@1140001 : RecordRef;VAR FldRef@1140002 : FieldRef);
    BEGIN
      IF PeriodFieldNo <> 0 THEN BEGIN
        FldRef := RecRef.FIELD(PeriodFieldNo);
        IF NOT CloseDate THEN
          FldRef.SETRANGE(Startdate,Enddate)
        ELSE BEGIN
          CloseDate1 := CLOSINGDATE(Enddate);
          IF Enddate <> CloseDate1 THEN BEGIN
           Enddate := CLOSINGDATE(Enddate);
          END;
        FldRef.SETRANGE(Startdate,Enddate);
        END;
        FindKeyFields(RecRef.NUMBER,FldRef.NAME);
      END;
    END;

    LOCAL PROCEDURE FindGDPdURecDefField@1140004(GDPdURecDefTable@1140000 : Record 11004;VAR RecRef@1140001 : RecordRef);
    VAR
      GDPdURecDefField@1140002 : Record 11005;
      Field@1140003 : Record 2000000041;
      FldRef@1140004 : FieldRef;
      NewString@1140005 : Text[1024];
      LastField@1140006 : Boolean;
      i@1140007 : Integer;
    BEGIN
      WITH GDPdURecDefTable DO BEGIN
        GDPdURecDefField.SETRANGE("Definition Group Code","Definition Group Code");
        GDPdURecDefField.SETRANGE("Record Code","Record Code");
        GDPdURecDefField.SETRANGE("Table No.","Table No.");
        IF GDPdURecDefField.FIND('-') THEN
          REPEAT
            FldRef := RecRef.FIELD(GDPdURecDefField."Field No.");
            Field.GET("Table No.",GDPdURecDefField."Field No.");
            IF Field.Class = Field.Class::FlowField THEN BEGIN
              FOR i := 1 TO RecRef.FIELDCOUNT DO BEGIN
                FldRef := RecRef.FIELDINDEX(i);
                IF FldRef.ACTIVE THEN BEGIN
                  Field.GET("Table No.",FldRef.NUMBER);
                  IF Field.Type = Field.Type::Date THEN
                    IF Field.Class = Field.Class::FlowFilter THEN BEGIN
                      CASE GDPdURecDefField."Datefilter Handling" OF
                        GDPdURecDefField."Datefilter Handling"::"Startdate..Enddate":
                          FldRef.SETRANGE(Startdate,Enddate);
                        GDPdURecDefField."Datefilter Handling"::"..Enddate":
                          FldRef.SETRANGE(0D,Enddate);
                        GDPdURecDefField."Datefilter Handling"::"..Startdate":
                          FldRef.SETRANGE(0D,Startdate-1);
                      END;
                    END;
                END;
              END;
              FldRef := RecRef.FIELD(GDPdURecDefField."Field No.");
              FldRef.CALCFIELD;
            END;
            FormatField2String(FldRef,RecRef.NUMBER,FldRef.NUMBER,NewString);
            LastField := GDPdURecDefField.NEXT = 0;
            InsertTempGDPdUExportBuffer(NewString,"Table No.",LastField,GDPdURecDefTable);
          UNTIL LastField;
      END;
    END;

    LOCAL PROCEDURE FormatField2String@1140005(VAR FldRef@1140000 : FieldRef;TableNo@1140001 : Integer;FieldNo@1140002 : Integer;VAR NewString@1140003 : Text[1024]);
    VAR
      Field@1140004 : Record 2000000041;
      GLSetup@1140005 : Record 98;
      OptionNo@1140006 : Integer;
      i@1140007 : Integer;
      OptionStr@1140008 : Text[1024];
      MaxDecLen@1140009 : Text[1];
    BEGIN
      Field.GET(TableNo,FieldNo);
      GLSetup.GET();
      CASE Field.Type OF
        Field.Type::Option:
          BEGIN
            OptionNo := FldRef.VALUE;
            OptionStr := FORMAT(FldRef.OPTIONCAPTION);
            FOR i := 1 TO OptionNo DO
              OptionStr := COPYSTR(OptionStr,STRPOS(OptionStr,',') + 1);
            NewString := OptionStr;
            IF STRPOS(OptionStr,',') > 0 THEN
              IF STRPOS(OptionStr,',') = 1 THEN
                NewString := ''
              ELSE
                NewString := COPYSTR(OptionStr,1,STRPOS(OptionStr,',') - 1);
          END;
        Field.Type::Decimal:
          BEGIN
            MaxDecLen := COPYSTR(GLSetup."Amount Decimal Places",STRLEN(GLSetup."Amount Decimal Places"));
            NewString := FORMAT(FldRef.VALUE,0,'<Precision,'+MaxDecLen+':'+MaxDecLen+'><Standard Format,0>');
          END;
        Field.Type::Date:
          BEGIN
            NewString := FORMAT(FldRef.VALUE,10,'<day,2>.<month,2>.<year4>');
          END;
        ELSE
          NewString := FORMAT(FldRef.VALUE);
      END;

      IF Field.Type IN [Field.Type::Boolean,Field.Type::Code,Field.Type::Option,Field.Type::Text] THEN BEGIN
        ConvertString(NewString);
        NewString := Text1140001 + NewString + Text1140001;
      END;
    END;

    LOCAL PROCEDURE ConvertString@1140006(VAR NewString@1140000 : Text[250]);
    VAR
      i@1140001 : Integer;
      StrgLength@1140002 : Integer;
      String1@1140003 : Text[10];
      String2@1140004 : Text[250];
      Char@1140005 : Char;
    BEGIN
      CLEAR(String2);
      StrgLength := STRLEN(NewString);
      FOR i := 1 TO StrgLength DO BEGIN
        String1 := ConvertSpecialChars(FORMAT(NewString[i]));
        String2 := String2 + String1;
      END;
      NewString := String2;
      FOR i := 128 TO 255 DO BEGIN
        Char := i;
        NewString := DELCHR(NewString,'=',FORMAT(Char));
      END;
    END;

    LOCAL PROCEDURE ConvertSpecialChars@1140007(Text@1140000 : Text[10]) : Text[10];
    BEGIN
      IF (Text[1] = 10) OR (Text[1] = 13) OR (Text[1] = 34) OR (Text[1] = 39) THEN
        EXIT('');
      CASE Text OF
        'é': Text := 'Ae';
        'Ñ': Text := 'ae';
        'ô': Text := 'Oe';
        'î': Text := 'oe';
        'ö': Text := 'Ue';
        'Å': Text := 'ue';
        '·': Text := 'ss';
      END;
      EXIT(Text);
    END;

    LOCAL PROCEDURE InsertTempGDPdUExportBuffer@1140008(FieldValue@1140000 : Text[250];TableNo@1140001 : Integer;LineFeed@1140002 : Boolean;GDPdURecDefTable@1140003 : Record 11004);
    BEGIN
      TempGDPdUExportBuffer.RESET;
      TempGDPdUExportBuffer.SETCURRENTKEY("Table No.","Line No.");
      TempGDPdUExportBuffer.SETRANGE("Table No.", TableNo);
      IF NOT TempGDPdUExportBuffer.FINDLAST THEN BEGIN
        NextEntryNo := NextEntryNo + 1;
        ExportBufferNextLineNo := 10000;
        GDPdUExportBufferFilename := GDPdURecDefTable."Export File Name";
        TempGDPdUExportBuffer.INIT;
        TempGDPdUExportBuffer."Entry No." := NextEntryNo;
        TempGDPdUExportBuffer."Table No." := TableNo;
        TempGDPdUExportBuffer."Field Value" := GDPdUExportBufferFilename;
        TempGDPdUExportBuffer."Line No." := ExportBufferNextLineNo;
        TempGDPdUExportBuffer.INSERT;

        IF NOT ISSERVICETIER THEN
          OpenNewFile(ExportPath + ' ' + FORMAT(NumberOfFolders) + '\' + GDPdUExportBufferFilename)
        ELSE BEGIN
          IF CheckPath THEN BEGIN
            Path := GetTempFilePath;
            CheckPath := FALSE;
        END;
          OpenNewFile(Path + '\' + GDPdUExportBufferFilename);
        END;

        TempFilesGDPdUExportBuffer.SETRANGE("Table No.",TableNo);
        IF TempFilesGDPdUExportBuffer.FINDFIRST THEN REPEAT
          TempFilesGDPdUExportBuffer."File No." := TempFilesGDPdUExportBuffer."File No." + 1;
          TempFilesGDPdUExportBuffer.MODIFY;
        UNTIL TempFilesGDPdUExportBuffer.NEXT = 0;

        ExportTempGDPdUExportBuffer(GDPdUExportBufferFilename,TableNo,NumberOfFolders,
          FieldValue,LineFeed);
        OldTableNo := TableNo;
        TextStreamClose;
      END ELSE BEGIN
        IF TableNo <> OldTableNo THEN BEGIN
          IF NOT ISSERVICETIER THEN BEGIN
            IF FileSysObjectServer.FileExists(ExportPath + ' ' + FORMAT(NumberOfFolders) + '\' +
              GDPdURecDefTable."Export File Name")
            THEN
              FileSysOpenTextFile(TextStream,ExportPath + ' ' + FORMAT(NumberOfFolders) + '\' +
                GDPdURecDefTable."Export File Name",8)
          ELSE BEGIN
              OpenNewFile(ExportPath + ' ' + FORMAT(NumberOfFolders) + '\' + GDPdURecDefTable."Export File Name");
              TempFilesGDPdUExportBuffer.SETRANGE("Table No.", TableNo);
              IF TempFilesGDPdUExportBuffer.FINDFIRST THEN
                REPEAT
                  TempFilesGDPdUExportBuffer."File No." := TempFilesGDPdUExportBuffer."File No." + 1;
                  TempFilesGDPdUExportBuffer.MODIFY;
                UNTIL TempFilesGDPdUExportBuffer.NEXT =0;
              FileIsOpen := TRUE;
            END;
          END ELSE BEGIN
            IF FileSysObjectServer.FileExists(Path + '\' + GDPdURecDefTable."Export File Name") THEN
              FileSysOpenTextFile(TextStream,Path + '\' + GDPdURecDefTable."Export File Name",8)
            ELSE BEGIN
              OpenNewFile(Path + '\' + GDPdURecDefTable."Export File Name");
              TempFilesGDPdUExportBuffer.SETRANGE("Table No.", TableNo);
              IF TempFilesGDPdUExportBuffer.FINDFIRST THEN
                REPEAT
                  TempFilesGDPdUExportBuffer."File No." := TempFilesGDPdUExportBuffer."File No." + 1;
                  TempFilesGDPdUExportBuffer.MODIFY;
                UNTIL TempFilesGDPdUExportBuffer.NEXT =0;
              FileIsOpen := TRUE;
            END;
          END;
          OldTableNo := TableNo;
          ExportTempGDPdUExportBuffer(GDPdURecDefTable."Export File Name",
            TableNo,NumberOfFolders,FieldValue,LineFeed);
          TextStreamClose;
        END ELSE BEGIN
          IF NOT ISSERVICETIER THEN
            FileSysOpenTextFile(TextStream,ExportPath + ' ' + FORMAT(NumberOfFolders) + '\' +
              GDPdURecDefTable."Export File Name",8)
          ELSE
            FileSysOpenTextFile(TextStream,Path + '\' + GDPdURecDefTable."Export File Name",8);

          ExportTempGDPdUExportBuffer(GDPdURecDefTable."Export File Name",
            TableNo,NumberOfFolders ,FieldValue,LineFeed);
          TextStreamClose;
            END;
      END;

      //// dach0004.begin
      //// NextEntryNo := NextEntryNo + 1;
      //// WITH TempGDPdUExportBuffer DO BEGIN
      ////   "Entry No." := NextEntryNo;
      ////   "Table No." := TableNo;
      ////   "Line Feed" := LineFeed;
      ////   "Field Value" := FieldValue;
      ////   INSERT;
      //// END;
      //IndexFieldValue := CONVERTSTR(FORMAT(STRLEN(FORMAT(LineFeed))+6,3),' ','0');
      //TempGDPdUExportBuffer.RESET;
      //TempGDPdUExportBuffer.SETCURRENTKEY("Table No.","Line No.");
      //TempGDPdUExportBuffer.SETRANGE("Table No.", TableNo);
      //IF NOT TempGDPdUExportBuffer.FIND('+') THEN BEGIN
      //  NextEntryNo := NextEntryNo + 1;
      //  ExportBufferNextLineNo := 10000;
      //  // dach0011.begin
      //  // GDPdUExportBufferFilename := 'TEMP' + CONVERTSTR(FORMAT(NextEntryNo,5),' ','0') + '_';
      //  // dach0011.end
      //  GetTempFileName(GDPdUExportBufferFilename);
      //  TempGDPdUExportBuffer.INIT;
      //  TempGDPdUExportBuffer."Entry No." := NextEntryNo;
      //  TempGDPdUExportBuffer."Table No." := TableNo;
      //  TempGDPdUExportBuffer."Field Value" := GDPdUExportBufferFilename;
      //  TempGDPdUExportBuffer."Line No." := ExportBufferNextLineNo;
      //  TempGDPdUExportBuffer.INSERT;

      //  // dach0011.begin
      //  IF GDPdUExportBufferFileIsOpen = TRUE THEN BEGIN
      //    GDPdUExportBufferFile.CLOSE;
      //    GDPdUExportBufferFileIsOpen := FALSE;
      //  END;
      //  // dach0011.end

      //  GDPdUExportBufferFile.TEXTMODE(TRUE);
      //  GDPdUExportBufferFile.WRITEMODE(TRUE);
      //  GDPdUExportBufferFile.CREATE(TempGDPdUExportBuffer."Field Value");
      //  GDPdUExportBufferFileIsOpen := TRUE;
      //  GDPdUExportBufferFile.WRITE(IndexFieldValue + ';' +
      //                              FORMAT(LineFeed) + ';' +
      //                              FieldValue);
      //  RecCounter := RecCounter + 1;
      //  OldTableNo := TableNo;
      //END ELSE BEGIN
      //  IF TableNo <> OldTableNo THEN BEGIN
      //    GDPdUExportBufferFile.CLOSE;
      //    GDPdUExportBufferFileIsOpen := FALSE;
      //    GDPdUExportBufferFile.TEXTMODE(TRUE);
      //    GDPdUExportBufferFile.WRITEMODE(TRUE);
      //    GDPdUExportBufferFile.OPEN(TempGDPdUExportBuffer."Field Value");
      //    GDPdUExportBufferFileIsOpen := TRUE;
      //    IF GDPdUExportBufferFile.LEN < MaxTempFileSize THEN
      //      GDPdUExportBufferFile.SEEK(GDPdUExportBufferFile.LEN)
      //    ELSE BEGIN
      //      GDPdUExportBufferFile.CLOSE;
      //      GDPdUExportBufferFileIsOpen := FALSE;
      //      NextEntryNo := NextEntryNo + 1;
      //      ExportBufferNextLineNo := ExportBufferNextLineNo + 10000;
      //      // dach0011.begin
      //      // GDPdUExportBufferFilename := 'TEMP' + CONVERTSTR(FORMAT(NextEntryNo,5),' ','0') + '_';
      //      // dach0011.end
      //      GetTempFileName(GDPdUExportBufferFilename);
      //      TempGDPdUExportBuffer.INIT;
      //      TempGDPdUExportBuffer."Entry No." := NextEntryNo;
      //      TempGDPdUExportBuffer."Table No." := TableNo;
      //      TempGDPdUExportBuffer."Field Value" := GDPdUExportBufferFilename;
      //      TempGDPdUExportBuffer."Line No." := ExportBufferNextLineNo;
      //      TempGDPdUExportBuffer.INSERT;
      //      GDPdUExportBufferFile.TEXTMODE(TRUE);
      //      GDPdUExportBufferFile.WRITEMODE(TRUE);
      //      GDPdUExportBufferFile.CREATE(TempGDPdUExportBuffer."Field Value");
      //      GDPdUExportBufferFileIsOpen := TRUE;
      //    END;
      //    OldTableNo := TableNo;
      //  END ELSE
      //    IF RecCounter MOD 1000 = 0 THEN
      //      IF GDPdUExportBufferFile.LEN >= MaxTempFileSize THEN BEGIN
      //        GDPdUExportBufferFile.CLOSE;
      //        GDPdUExportBufferFileIsOpen := FALSE;
      //        NextEntryNo := NextEntryNo + 1;
      //        ExportBufferNextLineNo := ExportBufferNextLineNo + 10000;
      //        // dach0011.begin
      //        // GDPdUExportBufferFilename := 'TEMP' + CONVERTSTR(FORMAT(NextEntryNo,5),' ','0') + '_';
      //        // dach0011.end
      //        GetTempFileName(GDPdUExportBufferFilename);
      //        TempGDPdUExportBuffer.INIT;
      //        TempGDPdUExportBuffer."Entry No." := NextEntryNo;
      //        TempGDPdUExportBuffer."Table No." := TableNo;
      //        TempGDPdUExportBuffer."Field Value" := GDPdUExportBufferFilename;
      //        TempGDPdUExportBuffer."Line No." := ExportBufferNextLineNo;
      //        TempGDPdUExportBuffer.INSERT;
      //        GDPdUExportBufferFile.TEXTMODE(TRUE);
      //        GDPdUExportBufferFile.WRITEMODE(TRUE);
      //        GDPdUExportBufferFile.CREATE(TempGDPdUExportBuffer."Field Value");
      //        GDPdUExportBufferFileIsOpen := TRUE;
      //      END;
      //  GDPdUExportBufferFile.WRITE(IndexFieldValue + ';' +
      //                              FORMAT(LineFeed) + ';' +
      //                              FieldValue);
      //  RecCounter := RecCounter + 1;
      //END;
      //// dach0004.end
    END;

    LOCAL PROCEDURE InsertTempGDPdUXMLBuffer@1140009(MediaName@1140000 : Text[250];Filename@1140001 : Text[250];TableNo@1140002 : Integer);
    BEGIN
      IF NOT TempGDPdUXMLBuffer.GET(MediaName,Filename) THEN BEGIN
        TempGDPdUXMLBuffer."Media Name" := MediaName;
        TempGDPdUXMLBuffer."File Name" := Filename;
        TempGDPdUXMLBuffer."Table No." := TableNo;
        TempGDPdUXMLBuffer.INSERT;
      END;
    END;

    LOCAL PROCEDURE InsertTempKeyBuffer@1140010(RecRef@1140000 : RecordRef) : Boolean;
    VAR
      KeyRef@1140001 : KeyRef;
      FldRef@1140002 : FieldRef;
      TempFldRef@1140003 : FieldRef;
      i@1140004 : Integer;
      MaxIndexFields@1140005 : Integer;
    BEGIN
      // Limitation due to no of primary key fields in buffer table
      MaxIndexFields := 7;

      TempRecRef.DELETEALL;

      TempRecRef.INIT;
      TempFldRef := TempRecRef.FIELD(1);
      TempFldRef.VALUE := RecRef.NUMBER;

      KeyRef := RecRef.KEYINDEX(1);
      FOR i := 1 TO KeyRef.FIELDCOUNT DO BEGIN
        IF i <= 7 THEN BEGIN
          FldRef := KeyRef.FIELDINDEX(i);
          TempFldRef := TempRecRef.FIELD(i+1);
          TempFldRef.VALUE := FORMAT(FldRef.VALUE);
        END;
      END;

      IF NOT TempRecRef.FIND THEN BEGIN
        TempRecRef.INSERT;
        EXIT(TRUE);
      END;
    END;

    LOCAL PROCEDURE ExportTempGDPdUExportBuffer@1140011(TempFileName@1140000 : Text[250];TableNo@1140001 : Integer;VAR NumberOfFolders@1140002 : Integer;FieldValue@1140003 : Text[250];LineFeed@1140004 : Boolean);
    BEGIN
      WriteFieldsToFile(FieldValue,LineFeed);
      IF LineFeed THEN BEGIN
        InsertTempGDPdUXMLBuffer(
          "GDPdU Record Definition"."Record Code" + ' ' + FORMAT(NumberOfFolders),TempFileName,TableNo);

        RecordRefTable.OPEN(TableNo);
        NoOfRecords := NoOfRecords + 1;
        IF (NoOfRecords >= NextStep) THEN BEGIN
        Window.UPDATE(5,ROUND(NoOfRecords / TotalNoOfRecords * 10000,1));
         NextStep := NextStep + StepValue;
        END;

        RecordRefTable.CLOSE;

        CurrentMediaSize := 0;

        FileSize := 0;
        FileSizeTotal := 0;
        TotalFileSize := 0;
        TempSizeGDPdUExportBuffer.RESET;
        TempSizeGDPdUExportBuffer.SETCURRENTKEY("Entry No.");
        IF TempSizeGDPdUExportBuffer.FINDSET THEN
          REPEAT
            IF FileSysObjectServer.FileExists(FileSysObjectServer.GetAbsolutePathName(TempSizeGDPdUExportBuffer."Field Value")) THEN
              BEGIN
                FileSysObjectFileSizecheck := FileSysObjectServer.GetFile(TempSizeGDPdUExportBuffer."Field Value");
                FileSize := FileSysObjectFileSizecheck.Size;
                FileSizeinText := FORMAT(FileSize);
                EVALUATE(TotalFileSize,FileSizeinText);
                FileSizeTotal := FileSizeTotal + TotalFileSize;
              END;
          UNTIL TempSizeGDPdUExportBuffer.NEXT = 0;
          CurrentMediaSize := FileSizeTotal + 5000;
        IF NumberOfFolders = 1 THEN BEGIN
          FileSysObjectFileSizecheck := FileSysObjectClient.GetFile(DTDPathFileName);
          FileSize := FileSysObjectFileSizecheck.Size;
          FileSizeinText := FORMAT(FileSize);
          EVALUATE(TotalFileSize,FileSizeinText);
          CurrentMediaSize := CurrentMediaSize + TotalFileSize;
        END;

        IF (CurrentMediaSize >= TotalMediaSize) THEN BEGIN
          IF ISSERVICETIER THEN BEGIN
            TextStreamClose;
            TempSizeGDPdUExportBuffer.RESET;
            TempSizeGDPdUExportBuffer.SETCURRENTKEY("Entry No.");
            IF TempSizeGDPdUExportBuffer.FINDSET THEN
              REPEAT
                IF FileSysObjectServer.FileExists(FileSysObjectServer.GetAbsolutePathName(TempSizeGDPdUExportBuffer."Field Value")) THEN
                  BEGIN
                    FileName := FileSysObjectServer.GetFileName(TempSizeGDPdUExportBuffer."Field Value");
                    TempPath := RBMgt.DownloadTempFile(TempSizeGDPdUExportBuffer."Field Value");
                    FileSysObjectServer.DeleteFile(TempSizeGDPdUExportBuffer."Field Value",TRUE);
                    FileSysObjectClient.MoveFile(TempPath,ExportPath + ' ' + FORMAT(NumberOfFolders) + '\' + FileName);
                  END;
              UNTIL TempSizeGDPdUExportBuffer.NEXT = 0;
          END;
          TempSizeGDPdUExportBuffer.RESET;
          TempSizeGDPdUExportBuffer.DELETEALL;

          NumberOfFolders := NumberOfFolders + 1;
          CreateExportFolder(ExportPath + ' ' + FORMAT(NumberOfFolders));
          TempGDPdUExportBuffer.RESET;
          TempGDPdUExportBuffer.SETRANGE("Table No.",TableNo);
          TempGDPdUExportBuffer.SETFILTER("Field Value",'<>%1',TempFileName);
          TempGDPdUExportBuffer.DELETEALL;
          NextEntryNoTemp := 0;
          IF NOT ISSERVICETIER THEN BEGIN
            TextStreamClose;
            OpenNewFile(ExportPath + ' ' + FORMAT(NumberOfFolders) + '\' + TempFileName);
          END ELSE
            OpenNewFile(Path + '\' + TempFileName);
          TempFilesGDPdUExportBuffer.SETRANGE("Table No.", TableNo);
          IF TempFilesGDPdUExportBuffer.FINDFIRST THEN
            REPEAT
              TempFilesGDPdUExportBuffer."File No." := TempFilesGDPdUExportBuffer."File No." + 1;
              TempFilesGDPdUExportBuffer.MODIFY;
            UNTIL TempFilesGDPdUExportBuffer.NEXT =0;
          CurrentMediaSize := 0;
        END;
      END;

      //// dach0004.begin
      //// WITH TempGDPdUExportBuffer DO BEGIN
      ////   OpenNewFile(ExportPath + ' ' + FORMAT(NumberOfFolders) + '\' + FileName);
      ////   SETCURRENTKEY("Table No.");
      ////   SETRANGE("Table No.",TableNo);
      ////   IF FIND('-') THEN
      ////     REPEAT
      ////       WriteFieldsToFile("Field Value","Line Feed");
      ////       IF "Line Feed" THEN BEGIN
      ////         InsertTempGDPdUXMLBuffer(
      ////           "GDPdU Record Definition"."Record Code" + ' ' + FORMAT(NumberOfFolders),FileName,TableNo);
      ////         IF (GDPdUFile.LEN + CurrentMediaSize) >= MediaSize THEN BEGIN
      ////           NumberOfFolders := NumberOfFolders + 1;
      ////           CreateExportFolder(ExportPath + ' ' + FORMAT(NumberOfFolders));
      ////           OpenNewFile(ExportPath + ' ' + FORMAT(NumberOfFolders) + '\' + FileName);
      ////           CurrentMediaSize := 0;
      ////         END;
      ////       END;
      ////     UNTIL NEXT = 0;
      //// END;
      // WITH TempGDPdUExportBuffer DO BEGIN
      //  // dach0015.begin
      //  //OpenNewFile(ExportPath + ' ' + FORMAT(NumberOfFolders) + '\' + FileName);
      //  IF NOT ISSERVICETIER THEN
      //    OpenNewFile(ExportPath + ' ' + FORMAT(NumberOfFolders) + '\' + FileName)
      //  ELSE
      //    OpenNewFile(FileName);
      //  // dach0015.end
      //  SETCURRENTKEY("Table No.","Line No.");
      //   SETRANGE("Table No.",TableNo);
      //  IF FIND('-') THEN REPEAT
      //    // dach0011.begin
      //    IF GDPdUExportBufferFileIsOpen = TRUE THEN BEGIN
      //      GDPdUExportBufferFile.CLOSE;
      //      GDPdUExportBufferFileIsOpen := FALSE;
      //    END;
      //    // dach0011.end
      //    GDPdUExportBufferFile.TEXTMODE(TRUE);
      //    GDPdUExportBufferFile.WRITEMODE(FALSE);
      //    GDPdUExportBufferFile.OPEN(TempGDPdUExportBuffer."Field Value");
      //    GDPdUExportBufferFileIsOpen := TRUE;
      //    WHILE GDPdUExportBufferFile.POS <> GDPdUExportBufferFile.LEN DO BEGIN
      //      GDPdUExportBufferFile.READ(Buffertext);
      //      EVALUATE(IndexFieldValue,COPYSTR(Buffertext,1,3));
      //      EVALUATE(LineFeed,COPYSTR(Buffertext,5,IndexFieldValue-6));
      //      FieldValue := COPYSTR(Buffertext,IndexFieldValue,STRLEN(Buffertext)-IndexFieldValue+1);
      //      WriteFieldsToFile(FieldValue,LineFeed);
      //      IF LineFeed THEN BEGIN
      //         InsertTempGDPdUXMLBuffer(
      //           "GDPdU Record Definition"."Record Code" + ' ' + FORMAT(NumberOfFolders),FileName,TableNo);
      //         IF (GDPdUFile.LEN + CurrentMediaSize) >= MediaSize THEN BEGIN
      //           NumberOfFolders := NumberOfFolders + 1;
      //           CreateExportFolder(ExportPath + ' ' + FORMAT(NumberOfFolders));
      //          // dach0015.begin
      //          //OpenNewFile(ExportPath + ' ' + FORMAT(NumberOfFolders) + '\' + FileName);
      //          IF NOT ISSERVICETIER THEN
      //            OpenNewFile(ExportPath + ' ' + FORMAT(NumberOfFolders) + '\' + FileName)
      //          ELSE
      //            OpenNewFile(FileName);
      //          // dach0015.end
      //           CurrentMediaSize := 0;
      //         END;
      //       END;
      //    END;
      //    GDPdUExportBufferFile.CLOSE;
      //    GDPdUExportBufferFileIsOpen := FALSE;
      //     UNTIL NEXT = 0;
      // END;
      //// dach0004.end
    END;

    LOCAL PROCEDURE CreateExportFolder@1140012(NewFolder@1140001 : Text[120]);
    BEGIN
      IF NOT FileSysObjectClient.FolderExists(NewFolder) THEN
        FileSysObjectClient.CreateFolder(NewFolder)
      ELSE BEGIN
        IF FolderExist THEN BEGIN
          IF NOT CONFIRM(Text1140053) THEN
            CurrReport.BREAK
          ELSE BEGIN
            FileSysObjectClient.DeleteFolder(NewFolder);
        FileSysObjectClient.CreateFolder(NewFolder);
            FolderExist := FALSE;
          END;
        END ELSE BEGIN
          FileSysObjectClient.DeleteFolder(NewFolder);
          FileSysObjectClient.CreateFolder(NewFolder);
        END;
      END;
      CurrentMediaSize := 0;
    END;

    LOCAL PROCEDURE OpenNewFile@1140013(NewFileName@1140000 : Text[255]);
    VAR
      DTDFile@1140002 : File;
    BEGIN
        TempSizeGDPdUExportBuffer.RESET;
        TempSizeGDPdUExportBuffer.SETCURRENTKEY("Entry No.");
        TempSizeGDPdUExportBuffer.SETRANGE("Field Value",NewFileName);
        IF NOT TempSizeGDPdUExportBuffer.FINDLAST THEN BEGIN
          NextEntryNoTemp := NextEntryNoTemp + 1;
          TempSizeGDPdUExportBuffer.INIT;
          TempSizeGDPdUExportBuffer."Entry No." := NextEntryNoTemp;
          TempSizeGDPdUExportBuffer."Field Value" := NewFileName;
          TempSizeGDPdUExportBuffer.INSERT;
        END;

      IF NOT FileIsOpen THEN
        FileSysObjectClient.CopyFile(DTDPathFileName,ExportPath + ' 1\' + DTDFileName,TRUE);

      TextStream := FileSysObjectServer.CreateTextFile(NewFileName);
      TextStreamIsOpen := TRUE;
      FileIsOpen := TRUE;
    END;

    LOCAL PROCEDURE WriteFieldsToFile@1140014(NewString@1140000 : Text[250];LastField@1140001 : Boolean);
    BEGIN



      IF NOT LastField THEN
      BEGIN
        NewString := NewString + ';';
        IF (STRLEN(BufferTextRec) + STRLEN(NewString) > 1024) THEN BEGIN
          TextStream.WriteLine(BufferTextRec);
          BufferTextRec := '' ;
          BufferTextRec := NewString;
        END ELSE
          BufferTextRec := BufferTextRec + NewString;
      END ELSE BEGIN
        NewString := NewString;
        IF (STRLEN(BufferTextRec) + STRLEN(NewString) > 1024) THEN BEGIN
          TextStream.WriteLine(BufferTextRec);
          BufferTextRec := '' ;
          BufferTextRec := NewString;
        END ELSE
          BufferTextRec := BufferTextRec + NewString;
        TextStream.WriteLine(BufferTextRec);
        BufferTextRec := '';
      END;
    END;

    PROCEDURE FindKeyFields@1140015(TableNo@1140000 : Integer;FieldName@1140001 : Text[30]);
    BEGIN
      IF NOT KeyFieldBuffer.GET(TableNo,FieldName) THEN BEGIN
        KeyFieldBuffer.INIT;
        KeyFieldBuffer."Table No." := TableNo;
        KeyFieldBuffer."Index Value 1" := FieldName;
        KeyFieldBuffer.INSERT;
      END;
    END;

    PROCEDURE FindKeyIndex@1140016(TableNo@1140000 : Integer) BestKeyIndex : Integer;
    VAR
      KeyFieldsFoundBuffer@1140001 : TEMPORARY Record 11008;
      RecRef@1140002 : RecordRef;
      KeyRef@1140003 : KeyRef;
      FldRef@1140004 : FieldRef;
      i@1140005 : Integer;
      j@1140006 : Integer;
      KeyFieldsFound@1140007 : Integer;
    BEGIN
      KeyFieldBuffer.RESET;
      KeyFieldBuffer.SETRANGE("Table No.",TableNo);
      IF NOT KeyFieldBuffer.FIND('-') THEN
        EXIT(1);
      IF KeyFieldBuffer."Best Key Index" <> 0 THEN
        EXIT(KeyFieldBuffer."Best Key Index");

      RecRef.OPEN(TableNo);
      FOR i := 1 TO RecRef.KEYCOUNT DO BEGIN
        KeyRef := RecRef.KEYINDEX(i);
        IF KeyRef.ACTIVE THEN BEGIN
          KeyFieldsFound := 0;
          FOR j := 1 TO KeyRef.FIELDCOUNT DO BEGIN
            FldRef := KeyRef.FIELDINDEX(j);
            IF KeyFieldBuffer.FIND('-') THEN BEGIN
              REPEAT
                IF FldRef.NAME = KeyFieldBuffer."Index Value 1" THEN
                  KeyFieldsFound := KeyFieldsFound + 1;
              UNTIL KeyFieldBuffer.NEXT = 0;
            END ELSE
              EXIT(1);
          END;

          KeyFieldsFoundBuffer."Entry No." := i;
          KeyFieldsFoundBuffer."Table No." := KeyFieldsFound;
          KeyFieldsFoundBuffer.INSERT;
        END;
      END;

      KeyFieldsFoundBuffer.SETCURRENTKEY("Table No.");
      IF KeyFieldsFoundBuffer.FIND('+') THEN BEGIN
        KeyFieldsFoundBuffer.SETRANGE("Table No.",KeyFieldsFoundBuffer."Table No.");
        KeyFieldsFoundBuffer.FIND('-');
        BestKeyIndex := KeyFieldsFoundBuffer."Entry No.";
      END ELSE
        BestKeyIndex := 1;

      KeyFieldBuffer.SETRANGE("Table No.",TableNo);
      KeyFieldBuffer.SETRANGE("Best Key Index",0);
      IF KeyFieldBuffer.FIND('-') THEN BEGIN
        KeyFieldBuffer."Best Key Index" := BestKeyIndex;
        KeyFieldBuffer.MODIFY;
      END;
      KeyFieldsFoundBuffer.RESET;
      KeyFieldsFoundBuffer.DELETEALL;
    END;

    LOCAL PROCEDURE GetTempFilePath@1140017() : Text[1024];
    VAR
      TempFile@1140001 : File;
      TempFileName@1101100000 : Text[1024];
    BEGIN
      TempFile.CREATETEMPFILE;
      TempFileName := TempFile.NAME;
      TempFile.CLOSE;
      EXIT(FileSysObjectServer.GetParentFolderName(TempFileName));
    END;

    LOCAL PROCEDURE DeleteTempTables@1140018();
    BEGIN
      TempGDPdUExportBuffer.RESET;
      IF TempGDPdUExportBuffer.FIND('-') THEN
        REPEAT
          GDPdUExportBufferFilename := TempGDPdUExportBuffer."Field Value";
          IF ERASE(GDPdUExportBufferFilename) THEN;
        UNTIL TempGDPdUExportBuffer.NEXT = 0;
      TempGDPdUExportBuffer.DELETEALL;
      TempGDPdUXMLBuffer.DELETEALL;
      TempRecRef.DELETEALL;
      TempFilesGDPdUExportBuffer.DELETEALL;
    END;

    LOCAL PROCEDURE CheckingRecordDefFields@1140019(GDPdUDefGroupCode@1140000 : Code[10];GDPdURecordCode@1140001 : Code[10]);
    VAR
      GDPdURecDefTable@1140002 : Record 11004;
      GDPdURecDefField@1140003 : Record 11005;
      RecRef@1140004 : RecordRef;
      KeyRef@1140005 : KeyRef;
      FldRef@1140006 : FieldRef;
      ActiveKeyFound@1140007 : Boolean;
      KeyFieldFound@1140008 : Boolean;
      NonKeyFieldFound@1140009 : Boolean;
      GDPdURecDefFieldMismatch@1140010 : Boolean;
      i@1140011 : Integer;
      j@1140012 : Integer;
    BEGIN
      GDPdURecDefTable.SETRANGE("Definition Group Code",GDPdUDefGroupCode);
      GDPdURecDefTable.SETRANGE("Record Code",GDPdURecordCode);
      IF GDPdURecDefTable.FIND('-') THEN REPEAT
        RecRef.OPEN(GDPdURecDefTable."Table No.");
        CLEAR(i);
        CLEAR(ActiveKeyFound);
        CLEAR(NonKeyFieldFound);
        CLEAR(GDPdURecDefFieldMismatch);
        REPEAT
          i := i + 1;
          KeyRef := RecRef.KEYINDEX(i);
          IF KeyRef.ACTIVE THEN
            ActiveKeyFound := TRUE;
        UNTIL (i >= RecRef.KEYCOUNT) OR ActiveKeyFound;
        IF ActiveKeyFound THEN BEGIN
          GDPdURecDefField.SETRANGE("Definition Group Code",GDPdUDefGroupCode);
          GDPdURecDefField.SETRANGE("Record Code",GDPdURecordCode);
          GDPdURecDefField.SETRANGE("Table No.",GDPdURecDefTable."Table No.");
          IF GDPdURecDefField.FIND('-') THEN REPEAT
            CLEAR(KeyFieldFound);
            FOR j := 1 TO KeyRef.FIELDCOUNT DO BEGIN
              FldRef := KeyRef.FIELDINDEX(j);
              IF GDPdURecDefField."Field No." = FldRef.NUMBER THEN
                KeyFieldFound := TRUE;
            END;
            IF NOT KeyFieldFound THEN
              NonKeyFieldFound := TRUE;
            IF NonKeyFieldFound AND KeyFieldFound THEN BEGIN
              GDPdURecDefFieldMismatch := TRUE;
              GDPdURecDefField.CALCFIELDS("Table Name");
              IF NOT CONFIRM(Text1140037 + '\' + '\' +
                             Text1140038 + ' ' +
                             Text1140039 + ' ' +
                             Text1140040 + '\' + '\' +
                             Text1140041,
                             TRUE,
                             GDPdURecDefField.TABLECAPTION,
                             GDPdURecDefField."Table Name") THEN
                ERROR('');
            END;
          UNTIL GDPdURecDefFieldMismatch OR (GDPdURecDefField.NEXT = 0);
        END;
        RecRef.CLOSE;
      UNTIL GDPdURecDefFieldMismatch OR (GDPdURecDefTable.NEXT = 0);
    END;

    PROCEDURE TextStreamClose@1140024();
    BEGIN
      IF TextStreamIsOpen THEN BEGIN
        TextStream.Close();
        TextStreamIsOpen := FALSE;
      END;
    END;

    PROCEDURE FileSysOpenTextFile@1140025(VAR TextStreamParam@1140002 : Automation "{F935DC20-1CF0-11D0-ADB9-00C04FD58A0B} 1.0:{0BB02EC0-EF49-11CF-8940-00A0C9054228}:'Windows Script Host Object Model'.TextStream";FileName@1140001 : Text[1024];Mode@1140000 : Integer);
    BEGIN
      TextStreamParam := FileSysObjectServer.OpenTextFile(FileName,Mode);
      TextStreamIsOpen := TRUE;
    END;

    BEGIN
    END.
  }
  RDLDATA
  {
  }
}

